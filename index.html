<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web端简易图片比例裁剪工具</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop stop-color='%230ea5e9'/%3E%3Cstop offset='1' stop-color='%230284c7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='14' fill='url(%23g)'/%3E%3Ctext x='50%' y='55%' font-family='Manrope,Segoe UI,Arial,sans-serif' font-size='28' fill='%23fff' text-anchor='middle' font-weight='700'%3EH%3C/text%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
  <style>
    :root {
      --bg: #eef2f7;
      --panel: #ffffff;
      --ink: #0f172a;
      --muted: #6b7280;
      --stroke: #d7deeb;
      --accent: #0ea5e9;
      --accent-strong: #0284c7;
      --warning: #f59e0b;
      --radius: 14px;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      --transition: 200ms ease;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Manrope', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(14, 165, 233, 0.08), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(14, 165, 233, 0.05), transparent 30%),
                  var(--bg);
      color: var(--ink);
      padding: 32px 20px 40px;
    }

    header {
      max-width: 1200px;
      margin: 0 auto 20px;
      display: flex;
      align-items: baseline;
      gap: 12px;
      padding: 0 4px;
    }

    .brand-icon {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      letter-spacing: -0.04em;
      box-shadow: 0 10px 20px rgba(14, 165, 233, 0.25);
    }

    h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: -0.02em;
    }

    .hint {
      color: var(--muted);
      font-size: 14px;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 18px;
      align-items: flex-start;
    }

    .stage {
      flex: 1 1 0;
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      position: relative;
      min-height: 640px;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .drop-zone {
      position: relative;
      width: 100%;
      border: 1.5px dashed var(--stroke);
      border-radius: calc(var(--radius) - 2px);
      background: linear-gradient(145deg, #f8fbff, #eef2f7);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
    }

    .drop-zone.active {
      border-color: var(--accent);
      box-shadow: 0 18px 30px rgba(14, 165, 233, 0.18);
      transform: translateY(-2px);
    }

    .drop-copy {
      text-align: center;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 24px;
      pointer-events: none;
      z-index: 2;
    }

    .drop-copy h3 {
      margin: 0;
      color: var(--ink);
      font-size: 20px;
      letter-spacing: -0.01em;
    }

    .drop-copy .meta {
      font-size: 12px;
      opacity: 0.7;
    }

    .drop-copy.hidden {
      display: none;
    }

    #previewImage {
      max-width: 100%;
      max-height: 100%;
      display: none;
    }

    .grid-overlay {
      position: absolute;
      border: 1px dashed rgba(14, 165, 233, 0.7);
      border-radius: 6px;
      pointer-events: none;
      z-index: 3;
      display: none;
      box-shadow:
        inset 0 0 0 1px rgba(255, 255, 255, 0.4),
        0 10px 24px rgba(14, 165, 233, 0.14);
      backdrop-filter: contrast(1.02);
    }

    .grid-line {
      position: absolute;
      background: linear-gradient(180deg, rgba(14, 165, 233, 0) 0%, rgba(14, 165, 233, 0.85) 50%, rgba(14, 165, 233, 0) 100%);
    }

    .grid-line.h {
      height: 1px;
      left: 0;
      right: 0;
      transform: translateY(-0.5px);
    }

    .grid-line.v {
      width: 1px;
      top: 0;
      bottom: 0;
      transform: translateX(-0.5px);
    }

    .controls {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow);
    }

    .panel h3 {
      margin: 0 0 10px;
      font-size: 16px;
      letter-spacing: -0.01em;
    }

    .ratio-group {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    button {
      border: 1px solid var(--stroke);
      background: #f8fafc;
      color: var(--ink);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition), transform var(--transition), box-shadow var(--transition);
    }

    button:hover {
      border-color: #c5d0e3;
      background: #fff;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: inset 0 1px 3px rgba(15, 23, 42, 0.1);
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border: none;
      color: #fff;
      box-shadow: 0 14px 26px rgba(14, 165, 233, 0.25);
    }

    button.primary:hover {
      box-shadow: 0 16px 30px rgba(14, 165, 233, 0.32);
    }

    button.warning {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border: none;
      color: #1f2937;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1 1 120px;
    }

    label {
      font-size: 13px;
      color: var(--muted);
    }

    input[type="number"] {
      border: 1px solid var(--stroke);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: #f8fafc;
      transition: border-color var(--transition), background var(--transition), box-shadow var(--transition);
    }

    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.16);
    }

    .ratio-group button.active {
      border-color: var(--accent);
      background: rgba(14, 165, 233, 0.12);
      color: var(--accent-strong);
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status {
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
      min-height: 18px;
    }

    .preview-box {
      height: 160px;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      background: #f8fafc;
      overflow: hidden;
    }

    .tips {
      display: grid;
      gap: 6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(14, 165, 233, 0.08);
      color: var(--accent-strong);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(14, 165, 233, 0.2);
    }

    .upload-trigger {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .toolbar button {
      flex: 1 1 48%;
    }

    .social-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--accent-strong);
      text-decoration: none;
      font-weight: 700;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(14, 165, 233, 0.08);
      border: 1px solid rgba(14, 165, 233, 0.2);
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
    }

    .social-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(14, 165, 233, 0.2);
      background: rgba(14, 165, 233, 0.12);
    }

    .social-link svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    footer {
      max-width: 1200px;
      margin: 24px auto 0;
      color: var(--muted);
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px 14px;
      padding: 12px 4px 0;
      border-top: 1px solid var(--stroke);
    }

    .footer-left {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      align-items: center;
    }

    .footer-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .footer-bottom {
      width: 100%;
      display: flex;
      justify-content: center;
      color: var(--muted);
      font-size: 11px;
      padding: 6px 0 4px;
    }

    @media (max-width: 1024px) {
      main {
        flex-direction: column;
      }
      .controls {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
      }
      .panel {
        flex: 1 1 260px;
      }
      .stage {
        min-height: 500px;
      }
    }

    @media (max-width: 720px) {
      body { padding: 22px 14px 32px; }
      header { flex-direction: column; align-items: flex-start; }
      .controls { flex-direction: column; }
      .toolbar button { flex: 1 1 100%; }
      .stage { min-height: 420px; }
      .preview-box { height: 140px; }
    }
  </style>
</head>
  <body>
  <header>
    <div class="brand-icon">HSn</div>
    <h1>Web端简易图片比例裁剪工具</h1>
    <div class="hint">单文件运行 · 拖拽/点击上传 · 自动 ZIP 打包</div>
  </header>

  <main>
    <section class="stage">
      <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept="image/*" hidden>
        <div class="drop-copy" id="dropCopy">
          <h3>拖拽图片到此处</h3>
          <div class="badge">或点击选择文件</div>
          <button class="upload-trigger" id="uploadBtn">选择图片</button>
          <div class="meta">支持 JPG · PNG · WebP</div>
        </div>
        <img id="previewImage" alt="Image preview">
        <div class="grid-overlay" id="gridOverlay"></div>
      </div>
    </section>

    <aside class="controls">
      <div class="panel">
        <h3>比例预设</h3>
        <div class="ratio-group" id="ratioGroup">
          <button data-ratio="1.7777778">16 : 9</button>
          <button data-ratio="1.3333333">4 : 3</button>
          <button data-ratio="1">1 : 1</button>
          <button data-ratio="free" class="active">自由比例（默认全图）</button>
        </div>
      </div>

      <div class="panel">
        <h3>操作</h3>
        <div class="toolbar">
          <button id="fitBtn">重新适配</button>
          <button id="flipBtn">镜像翻转</button>
        </div>
        <div class="actions">
          <button class="primary" id="downloadBtn">导出裁剪结果为 ZIP</button>
          <button class="warning" id="resetBtn">重置整个画布</button>
          <div class="status" id="status">等待图片加载... 默认全图裁成 6×4 张</div>
        </div>
      </div>

      <div class="panel">
        <h3>切分网格</h3>
        <div class="input-row">
          <div class="field">
            <label for="colsInput">列数</label>
            <input type="number" id="colsInput" min="1" value="6">
          </div>
          <div class="field">
            <label for="rowsInput">行数</label>
            <input type="number" id="rowsInput" min="1" value="4">
          </div>
        </div>
        <div class="hint">导出时按网格将当前裁剪区域分割成列×行张数</div>
      </div>

      <div class="panel">
        <h3>裁剪预览</h3>
        <div class="preview-box preview"></div>
      </div>

      <div class="panel">
        <h3>提示</h3>
        <div class="tips">
          <span>• 拖拽图片到左侧画布，或点击「选择图片」。</span>
          <span>• 默认全图裁成 6×4 张，可调整比例或网格列/行数后导出。</span>
          <span>• 支持直接粘贴剪贴板图片 (Cmd/Ctrl+V)。</span>
          <span>• 选择比例后，可拖动/缩放裁剪框；滚轮可缩放，双击可放大。</span>
          <span>• 导出时会按网格生成高清 PNG 分片，并打包为 ZIP 下载。</span>
        </div>
      </div>
    </aside>
  </main>

  <footer>
    <div class="footer-left">
      <span>Cropper.js · JSZip · 纯前端离线可用</span>
      <span>保持图片分辨率，导出高清裁剪区域</span>
    </div>
    <div class="footer-right">
      <a class="social-link" href="https://github.com/HSn0918/image-slicer-tool" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 .5C5.65.5.5 5.65.5 12c0 5.1 3.29 9.42 7.86 10.95.58.1.79-.25.79-.56 0-.28-.01-1.02-.02-2-3.2.7-3.88-1.54-3.88-1.54-.53-1.34-1.3-1.7-1.3-1.7-1.06-.72.08-.71.08-.71 1.18.08 1.8 1.22 1.8 1.22 1.04 1.78 2.72 1.27 3.38.97.1-.75.41-1.27.75-1.56-2.55-.29-5.24-1.28-5.24-5.7 0-1.26.45-2.3 1.2-3.11-.12-.29-.52-1.46.11-3.06 0 0 .97-.31 3.18 1.19a11.07 11.07 0 0 1 5.8 0c2.2-1.5 3.17-1.19 3.17-1.19.64 1.6.24 2.77.12 3.06.75.81 1.2 1.85 1.2 3.1 0 4.43-2.69 5.42-5.25 5.7.42.36.8 1.06.8 2.14 0 1.54-.01 2.79-.01 3.17 0 .31.21.67.8.55A10.99 10.99 0 0 0 23.5 12C23.5 5.65 18.35.5 12 .5Z"/>
        </svg>
        <span>GitHub 源码</span>
      </a>
    </div>
    <div class="footer-bottom">© HSn</div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const dropCopy = document.getElementById('dropCopy');
    const previewImage = document.getElementById('previewImage');
    const ratioGroup = document.getElementById('ratioGroup');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusEl = document.getElementById('status');
    const fitBtn = document.getElementById('fitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const flipBtn = document.getElementById('flipBtn');
    const colsInput = document.getElementById('colsInput');
    const rowsInput = document.getElementById('rowsInput');
    const gridOverlay = document.getElementById('gridOverlay');

    let cropper = null;
    let objectUrl = null;
    let filenameBase = 'cropped';
    let flipped = false;

    const setStatus = (text) => {
      statusEl.textContent = text;
    };

    const destroyCropper = () => {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      if (gridOverlay) {
        gridOverlay.style.display = 'none';
        gridOverlay.innerHTML = '';
      }
    };

    const loadImage = (file) => {
      if (!file || !file.type.startsWith('image/')) {
        setStatus('请选择图片文件（JPG/PNG/WebP 等）');
        return;
      }

      if (objectUrl) {
        URL.revokeObjectURL(objectUrl);
      }

      objectUrl = URL.createObjectURL(file);
      filenameBase = file.name.replace(/\.[^.]+$/, '') || 'cropped';

      previewImage.style.display = 'block';
      dropCopy.classList.add('hidden');
      destroyCropper();
      flipped = false;

      previewImage.onload = () => {
        cropper = new Cropper(previewImage, {
          aspectRatio: getActiveRatio(),
          viewMode: 1,
          autoCropArea: 1,
          background: false,
          dragMode: 'move',
          responsive: true,
          preview: '.preview',
          ready() {
            cropper.setAspectRatio(getActiveRatio());
            const canvasData = cropper.getCanvasData();
            cropper.setCropBoxData({
              left: canvasData.left,
              top: canvasData.top,
              width: canvasData.width,
              height: canvasData.height
            });
            updateGridOverlay();
            setStatus('图片已加载，默认全图裁成网格，可调整比例或网格数量');
          },
          crop: updateGridOverlay
        });
      };

      previewImage.src = objectUrl;
    };

    const triggerDownload = (blob, name) => {
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.download = name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    };

    const handleFiles = (files) => {
      if (!files || !files.length) return;
      loadImage(files[0]);
      fileInput.value = '';
    };

    const handlePaste = (event) => {
      const items = event.clipboardData && event.clipboardData.items;
      if (!items) return;
      for (const item of items) {
        if (item.type && item.type.startsWith('image/')) {
          const file = item.getAsFile();
          if (file) {
            loadImage(file);
            setStatus('已从剪贴板粘贴图片');
            return;
          }
        }
      }
      setStatus('剪贴板中未发现图片');
    };

    uploadBtn.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    ['dragenter', 'dragover'].forEach((evt) => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropZone.classList.add('active');
      });
    });

    ['dragleave', 'drop'].forEach((evt) => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
      });
    });

    dropZone.addEventListener('drop', (e) => {
      handleFiles(e.dataTransfer.files);
    });

    window.addEventListener('paste', handlePaste);

    ratioGroup.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-ratio]');
      if (!btn || !cropper) return;
      const ratio = btn.dataset.ratio === 'free' ? NaN : Number(btn.dataset.ratio);
      cropper.setAspectRatio(ratio);
      ratioGroup.querySelectorAll('button').forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      setStatus(btn.dataset.ratio === 'free' ? '已切换为自由比例' : `已切换为 ${btn.textContent.trim()} 比例`);
      updateGridOverlay();
    });

    fitBtn.addEventListener('click', () => {
      if (!cropper) return setStatus('请先加载图片');
      cropper.reset();
      cropper.setAspectRatio(getActiveRatio());
      flipped = false;
      const canvasData = cropper.getCanvasData();
      cropper.setCropBoxData({
        left: canvasData.left,
        top: canvasData.top,
        width: canvasData.width,
        height: canvasData.height
      });
      updateGridOverlay();
      setStatus('已重新适配并保持当前比例');
    });

    resetBtn.addEventListener('click', () => {
      destroyCropper();
      previewImage.style.display = 'none';
      dropCopy.classList.remove('hidden');
      flipped = false;
      ratioGroup.querySelectorAll('button').forEach((b) => {
        b.classList.toggle('active', b.dataset.ratio === 'free');
      });
      setStatus('已重置，重新拖拽或选择图片，默认全图裁成网格');
    });

    flipBtn.addEventListener('click', () => {
      if (!cropper) return setStatus('请先加载图片');
      flipped = !flipped;
      const scaleX = flipped ? -1 : 1;
      cropper.scaleX(scaleX);
      setStatus(flipped ? '已镜像翻转' : '已恢复原始方向');
    });

    const getActiveRatio = () => {
      const activeBtn = ratioGroup.querySelector('button.active');
      if (!activeBtn) return NaN;
      return activeBtn.dataset.ratio === 'free' ? NaN : Number(activeBtn.dataset.ratio);
    };

    const getGridCounts = () => {
      const cols = Math.max(1, parseInt(colsInput.value, 10) || 6);
      const rows = Math.max(1, parseInt(rowsInput.value, 10) || 4);
      return { cols, rows };
    };

    const updateGridOverlay = () => {
      if (!cropper || !gridOverlay) {
        if (gridOverlay) {
          gridOverlay.style.display = 'none';
          gridOverlay.innerHTML = '';
        }
        return;
      }
      const box = cropper.getCropBoxData();
      if (!box || !box.width || !box.height) {
        gridOverlay.style.display = 'none';
        return;
      }

      const { cols, rows } = getGridCounts();
      gridOverlay.style.display = 'block';
      gridOverlay.style.left = `${box.left}px`;
      gridOverlay.style.top = `${box.top}px`;
      gridOverlay.style.width = `${box.width}px`;
      gridOverlay.style.height = `${box.height}px`;

      gridOverlay.innerHTML = '';
      for (let c = 1; c < cols; c++) {
        const vLine = document.createElement('div');
        vLine.className = 'grid-line v';
        vLine.style.left = `${(c / cols) * 100}%`;
        gridOverlay.appendChild(vLine);
      }
      for (let r = 1; r < rows; r++) {
        const hLine = document.createElement('div');
        hLine.className = 'grid-line h';
        hLine.style.top = `${(r / rows) * 100}%`;
        gridOverlay.appendChild(hLine);
      }
    };

    colsInput.addEventListener('input', updateGridOverlay);
    rowsInput.addEventListener('input', updateGridOverlay);

    downloadBtn.addEventListener('click', async () => {
      if (!cropper) {
        setStatus('请先加载并裁剪图片');
        return;
      }

      const canvas = cropper.getCroppedCanvas({
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
      });

      if (!canvas) {
        setStatus('请先在图片上创建裁剪区域');
        return;
      }

      const { cols, rows } = getGridCounts();

      const canvasToBlob = (cvs) => new Promise((resolve) => {
        cvs.toBlob(resolve, 'image/png', 0.96);
      });

      setStatus(`正在生成 ${cols}×${rows} 分片并打包...`);

      const zip = new JSZip();
      const tileWBase = canvas.width / cols;
      const tileHBase = canvas.height / rows;
      const tileCanvas = document.createElement('canvas');
      const ctx = tileCanvas.getContext('2d');

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const sx = Math.round(c * tileWBase);
          const sy = Math.round(r * tileHBase);
          const sw = c === cols - 1 ? canvas.width - sx : Math.round(tileWBase);
          const sh = r === rows - 1 ? canvas.height - sy : Math.round(tileHBase);

          tileCanvas.width = sw;
          tileCanvas.height = sh;
          ctx.clearRect(0, 0, sw, sh);
          ctx.drawImage(canvas, sx, sy, sw, sh, 0, 0, sw, sh);

          const blob = await canvasToBlob(tileCanvas);
          if (blob) {
            const name = `${filenameBase}-c${c + 1}-r${r + 1}.png`;
            zip.file(name, blob);
          }
        }
      }

      try {
        setStatus('正在压缩 ZIP...');
        const zipBlob = await zip.generateAsync({
          type: 'blob',
          compression: 'DEFLATE',
          compressionOptions: { level: 9 }
        });
        const zipName = `${filenameBase}-${cols}x${rows}-grid.zip`;
        triggerDownload(zipBlob, zipName);
        setStatus('已完成导出：' + zipName);
      } catch (err) {
        console.error(err);
        setStatus('打包失败，请重试');
      }
    });
  </script>
</body>
</html>
